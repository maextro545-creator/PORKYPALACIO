<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>Porky a Palacio</title>
  <style>
    :root{
      --bannerH: 120px;        /* ALTURA DEL BANNER (aj√∫stala a tu publicidad real) */
      --maxW: 420px;
      --ui: rgba(255,255,255,.92);
      --shadow: 0 18px 60px rgba(0,0,0,.28);
    }

    html,body{
      margin:0; padding:0;
      height:100%;
      background:#0b2a5a;
      overflow:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    /* Anti ‚Äúbarra del navegador deforma‚Äù: usamos dvh/svh si existe + fallback con --vh */
    body{
      height: 100vh;
      height: 100svh;
      height: 100dvh;
      display:flex;
      flex-direction:column;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      background: radial-gradient(1200px 900px at 50% 0%, #1760b8 0%, #0b2a5a 55%, #071a38 100%);
    }

    .game-wrap{
      flex:1;
      display:flex;
      justify-content:center;
      align-items:flex-start; /* SUBE TODO */
      padding-top: 8px;       /* usa espacio vac√≠o de arriba */
      box-sizing:border-box;
    }

    .stage{
      width: min(96vw, var(--maxW));
      position:relative;
    }

    /* Header peque√±o para que no coma pantalla */
    .topbar{
      position:absolute;
      left:0; right:0;
      top: 6px;
      text-align:center;
      pointer-events:none;
      z-index:10;
    }
    .title{
      margin:0;
      font-weight:900;
      letter-spacing:2px;
      font-size: clamp(22px, 6vw, 36px);
      color:#eaf7ff;
      text-shadow: 0 4px 0 rgba(0,0,0,.28);
    }
    .subtitle{
      margin:4px 0 0;
      font-size: clamp(11px, 2.8vw, 14px);
      color: rgba(234,247,255,.9);
      text-shadow: 0 2px 0 rgba(0,0,0,.22);
    }

    canvas#c{
      width: 100%;
      height: auto;
      display:block;
      border-radius: 18px 18px 0 0;
      box-shadow: var(--shadow);
      background:#7ecfd4;
      image-rendering: pixelated;
      touch-action: manipulation;
      /* MUY IMPORTANTE: reserva espacio al banner para que SIEMPRE se vea */
      max-height: calc(100dvh - var(--bannerH) - 24px);
      max-height: calc(var(--vh, 1vh) * 100 - var(--bannerH) - 24px);
    }

    /* Men√∫/overlays */
    .overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 0 14px 16px;
      box-sizing:border-box;
      z-index:20;
      pointer-events:none;
    }

    .panel{
      width:100%;
      max-width: 420px;
      pointer-events:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
    }

    .btnrow{
      width:100%;
      display:flex;
      gap:12px;
    }

    .btn{
      flex:1;
      border:0;
      border-radius: 14px;
      padding: 10px 12px;            /* botones m√°s peque√±os para m√≥vil */
      font-weight: 900;
      letter-spacing: .5px;
      font-size: 14px;               /* letras m√°s peque√±as */
      cursor:pointer;
      color: #fff;
      box-shadow: 0 8px 20px rgba(0,0,0,.22);
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }

    .btn.play{ background:#1fb65b; }
    .btn.secondary{ background: rgba(255,255,255,.25); color:#eaf7ff; border: 1px solid rgba(255,255,255,.22); }
    .btn.back{ background: rgba(255,255,255,.22); }

    .credits{
      text-align:center;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: 1px;
      color: rgba(234,247,255,.85);
      text-shadow: 0 2px 0 rgba(0,0,0,.22);
      margin-top: 2px;
    }

    .card{
      width:100%;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(6px);
      border-radius: 16px;
      padding: 10px 12px;
      box-sizing:border-box;
      color: rgba(255,255,255,.92);
      font-size: 13px;
      line-height: 1.25;
    }
    .card h3{
      margin:0 0 6px;
      font-size: 13px;
      letter-spacing: .6px;
      text-transform: uppercase;
      opacity:.95;
    }
    .list{
      margin:0; padding-left: 18px;
    }
    .small{
      font-size: 12px;
      opacity:.95;
    }

    .hidden{ display:none !important; }

    /* Banner siempre visible abajo */
    .ad-banner{
      height: var(--bannerH);
      box-sizing:border-box;
      background: rgba(255,255,255,.95);
      border-top: 2px solid rgba(0,0,0,.08);
      display:flex;
      justify-content:center;
      align-items:center;
      padding: 8px;
    }
    .ad-inner{
      width: min(96vw, var(--maxW));
      height: 100%;
      border-radius: 14px;
      background: repeating-linear-gradient(
        45deg,
        rgba(0,0,0,.05),
        rgba(0,0,0,.05) 10px,
        rgba(0,0,0,.02) 10px,
        rgba(0,0,0,.02) 20px
      );
      display:flex;
      align-items:center;
      justify-content:center;
      color:#0b2a5a;
      font-weight: 900;
      letter-spacing: .7px;
      text-align:center;
    }

    /* Texto de ‚Äútap para saltar‚Äù */
    .hint{
      position:absolute;
      left:0; right:0;
      top: 62px;
      text-align:center;
      z-index:12;
      color: rgba(255,255,255,.9);
      font-weight:800;
      font-size: 12px;
      text-shadow: 0 2px 0 rgba(0,0,0,.22);
      pointer-events:none;
    }

    /* Cuando pierdes: botones m√°s peque√±os */
    .gameover .btn{
      padding: 9px 10px;
      font-size: 13px;
      border-radius: 13px;
    }
  </style>
</head>
<body>
  <div class="game-wrap">
    <div class="stage">
      <div class="topbar">
        <h1 class="title">PORKY A PALACIO</h1>
        <div class="subtitle">Atrapa la R celeste üê∑</div>
      </div>
      <div class="hint" id="hint">TOCA LA PANTALLA PARA SALTAR</div>

      <canvas id="c" width="360" height="520" aria-label="Juego Porky a Palacio"></canvas>

      <!-- OVERLAY: MEN√ö PRINCIPAL -->
      <div class="overlay" id="menu">
        <div class="panel">
          <div class="btnrow">
            <button class="btn play" id="btnPlay">JUGAR</button>
            <button class="btn secondary" id="btnRecords">RECORDS</button>
          </div>
          <div class="credits">CREADO POR KDS</div>
        </div>
      </div>

      <!-- OVERLAY: RECORDS -->
      <div class="overlay hidden" id="records">
        <div class="panel">
          <div class="card">
            <h3>Top 3</h3>
            <ol class="list" id="top3"></ol>
            <div class="small" style="margin-top:8px; opacity:.9;">* Guardado en este dispositivo (localStorage).</div>
          </div>
          <div class="btnrow">
            <button class="btn back" id="btnBackFromRecords">VOLVER</button>
          </div>
          <div class="credits">CREADO POR KDS</div>
        </div>
      </div>

      <!-- OVERLAY: GAME OVER -->
      <div class="overlay hidden gameover" id="gameOver">
        <div class="panel">
          <div class="card">
            <h3>¬°Perdiste!</h3>
            <div>Puntaje: <b id="finalScore">0</b></div>
            <div class="small" style="margin-top:6px;">Toca ‚ÄúReintentar‚Äù o vuelve al men√∫.</div>
          </div>
          <div class="btnrow">
            <button class="btn play" id="btnRetry">REINTENTAR</button>
            <button class="btn secondary" id="btnMenu">MEN√ö</button>
          </div>
          <div class="credits">CREADO POR KDS</div>
        </div>
      </div>

    </div>
  </div>

  <!-- BANNER FIJO ABAJO: SIEMPRE VISIBLE -->
  <div class="ad-banner">
    <div class="ad-inner" id="adSlot">
      <!-- AQU√ç REEMPLAZA POR TU C√ìDIGO DE PUBLICIDAD (Adsense u otro) -->
      BANNER PUBLICITARIO
    </div>
  </div>

  <script>
    /*********************
     *  ANTI ‚Äúbarra navegador‚Äù: calcula --vh real
     *********************/
    function setVh(){
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setVh();
    window.addEventListener('resize', setVh, {passive:true});

    /*********************
     *  CANVAS & JUEGO (simple estilo flappy)
     *********************/
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');

    const menu = document.getElementById('menu');
    const records = document.getElementById('records');
    const gameOver = document.getElementById('gameOver');
    const hint = document.getElementById('hint');

    const btnPlay = document.getElementById('btnPlay');
    const btnRecords = document.getElementById('btnRecords');
    const btnBackFromRecords = document.getElementById('btnBackFromRecords');
    const btnRetry = document.getElementById('btnRetry');
    const btnMenu = document.getElementById('btnMenu');

    const top3El = document.getElementById('top3');
    const finalScoreEl = document.getElementById('finalScore');

    // Ajuste de "subir cerdito + R": usamos una zona m√°s arriba (0.35 del alto)
    const pig = {
      x: 90,
      y: canvas.height * 0.35,   // üëà SUBIDO
      vy: 0,
      w: 46,
      h: 34
    };

    const letterR = {
      x: 0, y: 0, w: 38, h: 38
    };

    let score = 0;
    let running = false;
    let dead = false;

    const world = {
      g: 0.45,
      jump: -7.2,
      speed: 2.25,
      gap: 130,
      spawnEvery: 92,
      t: 0
    };

    let pipes = [];

    function resetGame(){
      score = 0;
      running = false;
      dead = false;
      world.t = 0;
      pipes = [];
      pig.x = 90;
      pig.y = canvas.height * 0.35; // üëà SUBIDO
      pig.vy = 0;
      placeLetter();
      hint.classList.remove('hidden');
      draw(); // pinta el men√∫ bonito
    }

    function placeLetter(){
      // La ‚ÄúR‚Äù sobre el cerdito, un poquito m√°s arriba
      letterR.x = pig.x + 25;
      letterR.y = pig.y - 60; // üëà SUBIDO
    }

    function spawnPipe(){
      const topMin = 70;
      const topMax = canvas.height - 170;
      const topH = Math.floor(topMin + Math.random() * (topMax - topMin));
      pipes.push({
        x: canvas.width + 20,
        w: 44,
        topH,
        gap: world.gap,
        passed:false
      });
    }

    function drawPixelPig(x,y){
      // cerdito pixel art simple
      ctx.save();
      ctx.translate(x,y);
      ctx.imageSmoothingEnabled = false;

      // cuerpo
      ctx.fillStyle = "#ff9fb4";
      ctx.fillRect(0, 8, 46, 22);

      // cabeza
      ctx.fillRect(28, 2, 18, 24);

      // hocico
      ctx.fillStyle = "#ff7f9f";
      ctx.fillRect(40, 12, 10, 8);

      // ojo
      ctx.fillStyle = "#111";
      ctx.fillRect(38, 10, 3, 3);

      // oreja
      ctx.fillStyle = "#ff86a6";
      ctx.fillRect(30, 0, 8, 6);

      // patas (animaci√≥n)
      const step = (Math.floor(world.t/6) % 2);
      ctx.fillStyle = "#ff86a6";
      ctx.fillRect(8, 30, 6, 6);
      ctx.fillRect(20, 30, 6, 6);
      ctx.fillRect(32, 30, 6, 6);
      if(step===0){
        ctx.fillRect(14, 30, 4, 6);
        ctx.fillRect(26, 30, 4, 6);
      } else {
        ctx.fillRect(12, 30, 4, 6);
        ctx.fillRect(24, 30, 4, 6);
      }

      ctx.restore();
    }

    function drawLetterR(){
      ctx.save();
      ctx.imageSmoothingEnabled = false;
      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.fillRect(letterR.x, letterR.y, letterR.w, letterR.h);
      ctx.strokeStyle = "rgba(0,0,0,.15)";
      ctx.strokeRect(letterR.x+0.5, letterR.y+0.5, letterR.w-1, letterR.h-1);

      // R celeste
      ctx.fillStyle = "#1fb7ff";
      // dibujito tipo pixel R
      const px = 4, py = 4;
      const gx = letterR.x + 10, gy = letterR.y + 7;
      // columna izquierda
      ctx.fillRect(gx, gy, px, py*6);
      // parte superior
      ctx.fillRect(gx, gy, px*4, py);
      // medio
      ctx.fillRect(gx, gy+py*3, px*4, py);
      // derecha arriba
      ctx.fillRect(gx+px*3, gy+py, px, py*2);
      // pata diagonal
      ctx.fillRect(gx+px*2, gy+py*4, px, py);
      ctx.fillRect(gx+px*3, gy+py*5, px, py);

      ctx.restore();
    }

    function draw(){
      // fondo
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#7ecfd4";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // monta√±as simples
      ctx.fillStyle = "rgba(0,0,0,.12)";
      ctx.beginPath();
      ctx.moveTo(0, canvas.height-80);
      ctx.lineTo(80, canvas.height-130);
      ctx.lineTo(170, canvas.height-90);
      ctx.lineTo(260, canvas.height-150);
      ctx.lineTo(360, canvas.height-100);
      ctx.lineTo(360, canvas.height);
      ctx.lineTo(0, canvas.height);
      ctx.closePath();
      ctx.fill();

      // suelo
      ctx.fillStyle = "rgba(0,0,0,.10)";
      ctx.fillRect(0, canvas.height-22, canvas.width, 22);

      // tuber√≠as
      for(const p of pipes){
        // top
        ctx.fillStyle = "#ffffff";
        ctx.globalAlpha = 0.7;
        ctx.fillRect(p.x, 0, p.w, p.topH);
        // bottom
        const bottomY = p.topH + p.gap;
        ctx.fillRect(p.x, bottomY, p.w, canvas.height - bottomY);
        ctx.globalAlpha = 1;
      }

      // R
      drawLetterR();

      // cerdito
      drawPixelPig(pig.x, pig.y);

      // score
      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.font = "900 20px system-ui, Arial";
      ctx.textAlign = "left";
      ctx.fillText(String(score), 12, 34);
    }

    function collideRect(ax,ay,aw,ah, bx,by,bw,bh){
      return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
    }

    function step(){
      if(!running){
        draw();
        return;
      }
      world.t++;

      // f√≠sica cerdito
      pig.vy += world.g;
      pig.y += pig.vy;

      // l√≠mites
      if(pig.y < 0) { pig.y = 0; pig.vy = 0; }
      if(pig.y + pig.h + 8 > canvas.height-22){
        die();
      }

      // R sigue al cerdito (un poco flotante)
      letterR.x = pig.x + 25;
      letterR.y = pig.y - 60;

      // spawn pipes
      if(world.t % world.spawnEvery === 0) spawnPipe();

      // mover pipes + colisiones
      for(const p of pipes){
        p.x -= world.speed;

        const bottomY = p.topH + p.gap;

        // colisi√≥n con top/bottom pipes (usa hitbox del cerdito)
        if(
          collideRect(pig.x, pig.y+6, pig.w, pig.h, p.x, 0, p.w, p.topH) ||
          collideRect(pig.x, pig.y+6, pig.w, pig.h, p.x, bottomY, p.w, canvas.height-bottomY)
        ){
          die();
        }

        // puntaje
        if(!p.passed && p.x + p.w < pig.x){
          p.passed = true;
          score++;
        }
      }
      // limpiar pipes
      pipes = pipes.filter(p => p.x + p.w > -10);

      // objetivo: ‚Äúatrapa la R‚Äù (si toca la R suma extra y reubica)
      if(collideRect(pig.x, pig.y, pig.w, pig.h, letterR.x, letterR.y, letterR.w, letterR.h)){
        score += 2;
        // ‚Äúsalta‚Äù un poco y coloca R arriba
        pig.vy = Math.min(pig.vy, -3);
        letterR.y = Math.max(20, letterR.y - 120);
      }

      draw();
      requestAnimationFrame(step);
    }

    function jump(){
      if(dead) return;
      if(!running){
        startGame();
        return;
      }
      pig.vy = world.jump;
      hint.classList.add('hidden');
    }

    function startGame(){
      menu.classList.add('hidden');
      records.classList.add('hidden');
      gameOver.classList.add('hidden');
      running = true;
      dead = false;
      hint.classList.remove('hidden');
      requestAnimationFrame(step);
    }

    function die(){
      if(dead) return;
      dead = true;
      running = false;
      hint.classList.add('hidden');
      finalScoreEl.textContent = score;
      saveScore(score);
      showGameOver();
      draw();
    }

    function showGameOver(){
      gameOver.classList.remove('hidden');
      menu.classList.add('hidden');
      records.classList.add('hidden');
    }

    function showMenu(){
      gameOver.classList.add('hidden');
      records.classList.add('hidden');
      menu.classList.remove('hidden');
      resetGame();
    }

    function showRecords(){
      menu.classList.add('hidden');
      gameOver.classList.add('hidden');
      records.classList.remove('hidden');
      renderTop3();
    }

    /*********************
     *  TOP 3 (localStorage)
     *********************/
    const KEY = "porky_records_top3_v1";
    function loadTop3(){
      try{
        const arr = JSON.parse(localStorage.getItem(KEY) || "[]");
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveScore(s){
      const arr = loadTop3();
      arr.push({ score: s, date: Date.now() });
      arr.sort((a,b)=> b.score - a.score);
      const top = arr.slice(0,3);
      localStorage.setItem(KEY, JSON.stringify(top));
    }
    function renderTop3(){
      const arr = loadTop3();
      top3El.innerHTML = "";
      if(arr.length === 0){
        top3El.innerHTML = "<li>Sin registros todav√≠a</li>";
        return;
      }
      arr.forEach((r,i)=>{
        const d = new Date(r.date);
        const li = document.createElement("li");
        li.innerHTML = `<b>${r.score}</b> <span style="opacity:.8">(${d.toLocaleDateString()})</span>`;
        top3El.appendChild(li);
      });
    }

    /*********************
     *  EVENTOS (tap/click)
     *********************/
    const onPointer = (e)=>{
      e.preventDefault();
      jump();
    };

    canvas.addEventListener('pointerdown', onPointer, {passive:false});
    document.addEventListener('keydown', (e)=>{
      if(e.code === "Space" || e.code === "ArrowUp") jump();
    });

    btnPlay.addEventListener('click', ()=>{ resetGame(); startGame(); });
    btnRecords.addEventListener('click', showRecords);
    btnBackFromRecords.addEventListener('click', showMenu);
    btnRetry.addEventListener('click', ()=>{ resetGame(); startGame(); });
    btnMenu.addEventListener('click', showMenu);

    // Evita ‚Äúdoble tap zoom‚Äù raro en iOS
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) event.preventDefault();
      lastTouchEnd = now;
    }, {passive:false});

    // Inicio
    resetGame();
    renderTop3();
    draw();
  </script>
</body>
</html>
